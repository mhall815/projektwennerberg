version: 1
metadata:
  name: projektwennerberg-setup
  labels:
    blueprints.goauthentik.io/description: "Complete setup for Traefik and Hello World authentication"
    blueprints.goauthentik.io/instantiate: "true"

entries:
  # =====================================
  # GROUPS
  # =====================================
  
  - model: authentik_core.group
    id: admins
    identifiers:
      name: Administrators
    attrs:
      name: Administrators
      is_superuser: true

  - model: authentik_core.group
    id: users
    identifiers:
      name: Users
    attrs:
      name: Users

  # =====================================
  # PROXY PROVIDERS
  # =====================================


  - model: authentik_providers_proxy.proxyprovider
    id: hello-provider
    identifiers:
      name: Hello World App
    attrs:
      name: Hello World App
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      internal_host: http://helloworld_hello:80
      external_host: https://projektwennerberg.org
      mode: forward_single
      forward_auth_mode: nginx

  # =====================================
  # APPLICATIONS
  # =====================================

  - model: authentik_core.application
    id: hello-app
    identifiers:
      slug: hello-world
    attrs:
      name: Hello World
      slug: hello-world
      provider: !KeyOf hello-provider
      meta_description: Hello World demonstration app
      meta_publisher: ProjektWennerberg

  # =====================================
  # POLICIES
  # =====================================

  - model: authentik_policies_expression.expressionpolicy
    id: all-users-policy
    identifiers:
      name: All Authenticated Users
    attrs:
      name: All Authenticated Users
      expression: |
        return True

  # =====================================
  # POLICY BINDINGS
  # =====================================



  - model: authentik_policies_binding.policybinding
    id: hello-all-binding
    identifiers:
      target: !KeyOf hello-app
      policy: !KeyOf all-users-policy
    attrs:
      target: !KeyOf hello-app
      policy: !KeyOf all-users-policy
      order: 0